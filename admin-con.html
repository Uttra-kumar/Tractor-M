<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Fleets - Tractor-M</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --primary: #2E7D32;
      --primary-light: #4CAF50;
      --primary-dark: #1B5E20;
      --secondary: #FF9800;
      --secondary-light: #FFC107;
      --secondary-dark: #F57C00;
      --text: #333333;
      --text-light: #5a5a5a;
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --shadow: rgba(0, 0, 0, 0.08);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg);
      color: var(--text);
    }
    
    .header-bg {
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
    }
    
    .table-header {
      background-color: rgba(46, 125, 50, 0.1);
    }
    
    .user-id-badge {
      background: linear-gradient(to right, var(--primary-light), var(--primary));
    }
    
    .stats-card {
      background: linear-gradient(to right, var(--primary-light), var(--primary));
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>

<body class="min-h-screen p-6">
  <!-- Header -->
  <div class="header-bg text-white rounded-lg shadow-lg p-4 mb-6 flex justify-between items-center">
    <div class="flex items-center">
      <i class="fas fa-tractor text-3xl mr-3 pulse"></i>
      <h1 class="text-2xl font-bold">User Fleets Dashboard - Tractor-M</h1>
    </div>
    <a href="admin-data.html" class="bg-white text-green-700 px-4 py-2 rounded-lg font-medium hover:bg-green-50">
      <i class="fas fa-arrow-left mr-2"></i>Back to Users
    </a>
  </div>

  <!-- User Info -->
  <div class="bg-white rounded-lg shadow-md p-4 mb-6 flex items-center justify-between">
    <div>
      <div class="user-id-badge text-white px-4 py-2 rounded-full inline-block">
        <i class="fas fa-user-circle mr-2"></i>
        <span id="userId">Loading User ID...</span>
      </div>
    </div>
    <div class="text-sm text-gray-500">
      <i class="fas fa-info-circle mr-1"></i> Viewing fleet data for this user only
    </div>
  </div>

  <!-- Stats Summary -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="stats-card text-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-3xl font-bold" id="totalRecords">0</div>
          <div class="text-sm opacity-90">Total Records</div>
        </div>
        <i class="fas fa-list-ol text-2xl opacity-80"></i>
      </div>
    </div>
    
    <div class="stats-card text-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-3xl font-bold" id="totalHours">0</div>
          <div class="text-sm opacity-90">Total Hours</div>
        </div>
        <i class="fas fa-clock text-2xl opacity-80"></i>
      </div>
    </div>
    
    
  </div>

  <!-- Fleet Table -->
  <div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="p-4 border-b flex justify-between items-center">
      <h2 class="text-xl font-semibold text-green-700">
        <i class="fas fa-table mr-2"></i> Fleet Records
      </h2>
      <div class="text-sm text-gray-500">
        Sorted by: <select id="sortSelect" class="ml-2 border rounded px-2 py-1">
          <option value="date-desc">Date (Newest First)</option>
          <option value="date-asc">Date (Oldest First)</option>
          <option value="time-desc">Running Time (High to Low)</option>
          <option value="time-asc">Running Time (Low to High)</option>
        </select>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table id="fleetTable" class="min-w-full">
        <thead class="table-header text-green-800">
          <tr>
            <th class="px-6 py-3 text-left font-semibold">G-ID</th>
            <th class="px-6 py-3 text-left font-semibold">Name</th>
            <th class="px-6 py-3 text-left font-semibold">Paid</th>
            <th class="px-6 py-3 text-left font-semibold">Remain</th>
            <th class="px-6 py-3 text-left font-semibold">Total</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
    
    <!-- Empty State -->
    <div id="emptyState" class="hidden p-8 text-center">
      <i class="fas fa-inbox text-5xl text-gray-300 mb-4"></i>
      <h3 class="text-lg font-medium text-gray-500">No Transaction records found</h3>
      <p class="text-gray-400">This user doesn't have any cons data yet.</p>
    </div>
  </div>

  <script>

    document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            console.log(isLoggedIn)
            if (!isLoggedIn || isLoggedIn !== 'true') {
                alert('Please log in to access this page.');
                window.location.replace('admin-login.html');
                return;
            }
        });
    // URL se userId lena
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get("userId");
    console.log("URL User ID:", userId);
    document.getElementById("userId").innerText = "User ID: " + userId;

    let allMatchedFleets = [];

    function updateStats(fleets) {
      const totalRecords = fleets.length;
      let totalHours = 0;
      
      fleets.forEach(fleet => {
        totalHours += parseFloat(fleet.totalVal) || 0;
      });
      
      
      
      document.getElementById("totalRecords").textContent = totalRecords;
      document.getElementById("totalHours").textContent = totalHours.toFixed(2);
      
    }

    function sortFleets(fleets, sortBy) {
      return [...fleets].sort((a, b) => {
        switch(sortBy) {
          case 'date-asc':
            return new Date(a.date) - new Date(b.date);
          case 'date-desc':
            return new Date(b.date) - new Date(a.date);
          case 'time-asc':
            return (parseFloat(a.runningTime) || 0) - (parseFloat(b.runningTime) || 0);
          case 'time-desc':
            return (parseFloat(b.runningTime) || 0) - (parseFloat(a.runningTime) || 0);
          default:
            return new Date(b.date) - new Date(a.date);
        }
      });
    }

    function renderFleetTable(fleets) {
      const tbody = document.querySelector("#fleetTable tbody");
      const emptyState = document.getElementById("emptyState");
      tbody.innerHTML = "";

      if (fleets.length === 0) {
        tbody.innerHTML = "";
        emptyState.classList.remove("hidden");
      } else {
        emptyState.classList.add("hidden");
        fleets.forEach(fleet => {
          const row = document.createElement("tr");
          row.className = "hover:bg-green-50 transition-colors";
          
          // Format time if available
          let formattedTime = fleet.time || '-';
          if (fleet.time && fleet.time.includes(':')) {
            const [hours, minutes] = fleet.time.split(':');
            const hourNum = parseInt(hours);
            const ampm = hourNum >= 12 ? 'PM' : 'AM';
            const displayHour = hourNum % 12 || 12;
            formattedTime = `${displayHour}:${minutes} ${ampm}`;
          }
          
          row.innerHTML = `
            <td class="px-6 py-4 font-medium text-green-700">${fleet.gid}</td>
            <td class="px-6 py-4">${fleet.name}</td>
            <td class="px-6 py-4">${fleet.paid}</td>
            <td class="px-6 py-4">${fleet.remains}</td>

            <td class="px-6 py-4 font-medium">${fleet.totalVal}</td>
            
          `;
          tbody.appendChild(row);
        });
      }
    }

    function loadFleetData() {
      const request = indexedDB.open("Tractor-JM", 1);

      request.onupgradeneeded = function (event) {
        const db = event.target.result;
        if (!db.objectStoreNames.contains("payments")) {
          const store = db.createObjectStore("fleet", { keyPath: "gid" });
          store.createIndex("userId", "userId", { unique: false });
        }
      };

      request.onsuccess = function (event) {
        const db = event.target.result;
        const tx = db.transaction("payments", "readonly");
        const store = tx.objectStore("payments");

        // Get all fleet records
        const getAllRequest = store.getAll();
        getAllRequest.onsuccess = function (e) {
          const allFleets = e.target.result;

          // Filter fleets for this userId
          allMatchedFleets = allFleets.filter(fleet => fleet.gid === userId);
          
          // Update stats
          updateStats(allMatchedFleets);
          
          // Sort and render table
          const sortBy = document.getElementById("sortSelect").value;
          const sortedFleets = sortFleets(allMatchedFleets, sortBy);
          renderFleetTable(sortedFleets);

          console.log("Matched Fleets:", allMatchedFleets);
        };

        getAllRequest.onerror = function (e) {
          console.error("Error reading fleet data:", e.target.error);
        };
      };

      request.onerror = function (event) {
        console.error("Database open failed:", event.target.error);
      };
    }

    // Add event listener for sort selection
    document.getElementById("sortSelect").addEventListener("change", function() {
      const sortBy = this.value;
      const sortedFleets = sortFleets(allMatchedFleets, sortBy);
      renderFleetTable(sortedFleets);
    });

    loadFleetData();
  </script>

</body>
</html>
